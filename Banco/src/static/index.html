<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM Concurrente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
         * Mi intento de un diseño más moderno y cool.
         * Usando gradientes y un toque de glassmorphism.
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container-atm {
            max-width: 750px;
        }
        
        .glass-card {
            /* ¡Efecto de cristal que me encanta! */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .saldo-display {
            font-size: 2rem;
            font-weight: 800;
            /* Gradiente para que el saldo se vea potente */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .log-box {
            height: 200px;
            overflow-y: auto;
            /* Fondo sutil para el log */
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        /* Personalización de la scrollbar para que quede bien con el diseño */
        .log-box::-webkit-scrollbar {
            width: 6px;
        }
        
        .log-box::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }
        
        .log-box::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .log-item {
            padding: 3px 6px;
            border-bottom: 1px dotted rgba(102, 126, 234, 0.15);
            font-size: 0.75rem;
        }
        
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #667eea; }
        
        /* Estilos base para los botones principales */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            /* Un pequeño efecto al pasar el mouse */
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-deposit {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-deposit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-withdraw {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-withdraw:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            /* Un anillo de enfoque suave */
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body class="p-3 md:p-6 min-h-screen flex items-start justify-center">
    <div id="app" class="container-atm w-full glass-card shadow-2xl rounded-2xl p-5 md:p-7 transition-all duration-300">
        <header class="text-center mb-5">
            <h1 class="text-2xl md:text-3xl font-extrabold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">Simulador de ATM Concurrente</h1>
            <p class="text-gray-600 text-xs md:text-sm mt-1">Prueba la Condición de Carrera con múltiples dispositivos (Mutex ON/OFF).</p>
        </header>

        <div id="cajero-screen">
            <div id="login-panel" class="space-y-4">
                <h2 class="text-lg font-semibold text-center text-gray-700">Iniciar Sesión de Cajero</h2>
                <div class="flex flex-col space-y-3">
                    <div>
                        <label for="cajero_id" class="block text-xs font-medium text-gray-700 mb-1">ID de Cajero (Ej: 1001, 1002, 1003)</label>
                        <input type="text" id="cajero_id" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm transition-all" required>
                    </div>
                    <div>
                        <label for="pin" class="block text-xs font-medium text-gray-700 mb-1">PIN</label>
                        <input type="password" id="pin" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm transition-all" required>
                    </div>
                    <button onclick="handleLogin()" class="w-full py-2.5 btn-primary text-white font-bold text-sm rounded-lg transition-all">Entrar al Sistema</button>
                    <p class="text-xs text-gray-500 text-center mt-2">Cajeros de Prueba: 1001/1234, 1002/4321, 1003/0000</p>
                </div>
            </div>

            <div id="transaction-panel" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-inner">
                        <p class="text-xs font-medium text-purple-800">Cajero Activo:</p>
                        <p id="cajero-name" class="text-base font-bold mb-3 text-purple-900">N/A</p>

                        <p class="text-xs text-gray-600 mb-1">Saldo Actual de la Cuenta Única:</p>
                        <div id="saldo-display" class="saldo-display mb-4">$0.00</div>

                        <button onclick="consultarSaldo()" class="w-full py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-all text-xs font-medium shadow-sm border border-gray-200">Actualizar Saldo</button>
                        <button onclick="handleLogout()" class="w-full mt-2 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all text-xs font-medium shadow-sm">Cerrar Sesión</button>
                    </div>

                    <div class="lg:col-span-2 space-y-4">
                        <h3 class="text-base font-semibold text-gray-700">Operaciones Bancarias</h3>
                        
                        <div>
                            <label for="monto" class="block text-sm font-bold text-gray-700 mb-2">Monto de la Transacción:</label>
                            <input type="number" id="monto" value="100" min="1" class="block w-full rounded-lg border-gray-300 shadow-md p-3 text-xl text-center transition-all" required>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="handleTransaction('depositar')" class="py-3 btn-deposit text-white font-bold text-sm rounded-xl transition-all flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                                DEPOSITAR
                            </button>
                            <button onclick="handleTransaction('retirar')" class="py-3 btn-withdraw text-white font-bold text-sm rounded-xl transition-all flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                                </svg>
                                RETIRAR
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5">
                    <h3 class="text-base font-semibold text-gray-700 mb-2">Registro de Operaciones Concurrentes</h3>
                    <div id="log-list" class="log-box p-2 rounded-lg font-mono"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // La URL de mi servidor Flask. ¡OJO! Si estás en otra PC, usa tu IP, no 'localhost'.
        // Flask está en el puerto 5001, así que lo pongo aquí.
        const API_BASE_URL = window.location.protocol + '//' + window.location.hostname + ':5001';
        
        // --- COSAS DE LA INTERFAZ (UI) ---

        // Función para mandar mensajes al log. Es útil para ver qué está pasando.
        function logMessage(message, type = 'info') {
            const logList = document.getElementById('log-list');
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            // Los logs más nuevos van arriba para no hacer tanto scroll.
            logList.prepend(item); 
        }

        // Simplemente actualiza el número del saldo y le da formato de moneda.
        function updateSaldo(saldo) {
            const saldoDisplay = document.getElementById('saldo-display');
            // Formatear el saldo a moneda (ej: $1,000.00)
            saldoDisplay.textContent = new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(saldo);
        }
        
        // Muestra u oculta los paneles de Login y Transacción.
        function toggleScreens(isLoggedIn) {
            document.getElementById('login-panel').classList.toggle('hidden', isLoggedIn);
            document.getElementById('transaction-panel').classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                document.getElementById('cajero-name').textContent = sessionStorage.getItem('cajero_nombre') || 'Cajero Desconocido';
                consultarSaldo();
                logMessage('¡Sesión iniciada! A probar la concurrencia.', 'info');
            } else {
                updateSaldo(0);
                logMessage('Sesión cerrada. Toca volver a entrar.', 'info');
            }
        }

        // --- LÓGICA CON EL SERVIDOR (API) ---

        // Reviso si ya estoy logueado al cargar la página.
        async function checkStatus() {
            const cajeroId = sessionStorage.getItem('cajero_id');
            const cajeroNombre = sessionStorage.getItem('cajero_nombre');

            // Si tengo datos guardados, asumo que sí.
            if (cajeroId && cajeroNombre) {
                toggleScreens(true);
            } else {
                toggleScreens(false);
            }
        }

        // Intentar loguear al cajero con el ID y PIN.
        async function handleLogin() {
            const cajero_id = document.getElementById('cajero_id').value;
            const pin = document.getElementById('pin').value;
            
            if (!cajero_id || !pin) {
                logMessage('Falta el ID o el PIN, ¡no seas olvidadizo!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cajero_id, pin })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Guardo los datos del cajero en el navegador (sessionStorage)
                    sessionStorage.setItem('cajero_id', cajero_id);
                    sessionStorage.setItem('cajero_nombre', data.cajero);
                    toggleScreens(true);
                } else {
                    logMessage(`Error de Login: ${data.message}`, 'error');
                }
            } catch (error) {
                logMessage(`¡No puedo conectar con el servidor! Error: ${error.message}. ¿Flask está corriendo en el 5001?`, 'error');
            }
        }
        
        // Función para cerrar la sesión (borra los datos guardados).
        async function handleLogout() {
            await fetch(`${API_BASE_URL}/logout`, { method: 'POST' });
            sessionStorage.removeItem('cajero_id');
            sessionStorage.removeItem('cajero_nombre');
            toggleScreens(false);
            // Ya que estamos, limpio el formulario para que sea más fácil volver a entrar
            document.getElementById('cajero_id').value = '';
            document.getElementById('pin').value = '';
        }


        // Pedir el saldo actual al servidor.
        async function consultarSaldo() {
            try {
                const response = await fetch(`${API_BASE_URL}/saldo`);
                const data = await response.json();

                if (data.status === 'success') {
                    updateSaldo(data.saldo);
                    return data.saldo;
                } else {
                    logMessage(`Hubo un problema al pedir el saldo: ${data.message}`, 'error');
                }
            } catch (error) {
                logMessage('Error de conexión al consultar saldo. ¿El servidor está bien?', 'error');
            }
        }

        // La función clave: Depósito o Retiro.
        async function handleTransaction(type) {
            const montoInput = document.getElementById('monto');
            // Aseguro que sea un número entero, si no, es 0.
            const monto = parseInt(montoInput.value); 
            const cajeroNombre = sessionStorage.getItem('cajero_nombre') || 'Cajero Desconocido';
            
            if (isNaN(monto) || monto <= 0) {
                logMessage('¡El monto no es válido! Debe ser un número positivo.', 'error');
                return;
            }

            // Aviso que la transacción va a empezar.
            logMessage(`[${cajeroNombre}] Intentando ${type.toUpperCase()} $${monto}...`, 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/${type}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // El token no es necesario, Flask usa cookies de sesión.
                    },
                    body: JSON.stringify({ monto })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    updateSaldo(data.saldo_final);
                    logMessage(`[${data.cajero_nombre}] ${type.toUpperCase()} $${monto} - ¡LISTO! Saldo Final: $${data.saldo_final}`, 'log-success');
                } else if (data.status === 'auth_error') {
                    logMessage(`[${cajeroNombre}] ¡Fallo de autenticación! Cerrando sesión por seguridad.`, 'error');
                    handleLogout();
                } else {
                    logMessage(`[${cajeroNombre}] ${type.toUpperCase()} $${monto} - ¡OH NO! ERROR: ${data.message}`, 'log-error');
                }
            } catch (error) {
                logMessage(`Error de red durante la transacción: ${error.message}. Revisa la conexión.`, 'error');
            }
        }

        // Empezar a revisar el estado cuando cargue la página
        window.onload = checkStatus;

    </script>
</body>
</html>
